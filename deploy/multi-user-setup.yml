---
# Rocky Linux 9 ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒæ§‹ç¯‰ Ansible Playbook
# é™ã‚‰ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã«ç‹¬ç«‹ã—ãŸClaude Codeç’°å¢ƒã‚’æä¾›

- name: Configure multi-user Claude Code environment on Rocky Linux 9
  hosts: rocky_llm_vms
  become: yes
  gather_facts: yes
  vars:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾© - å®Ÿéš›ã®é‹ç”¨æ™‚ã¯ vault.yml ã§æš—å·åŒ–ã—ã¦ç®¡ç†
    claude_users:
      - name: user1
        full_name: "Developer User 1"
        uid: 2001
        initial_password_hash: "$6$rounds=4096$salted_hash_here"  # mkpasswd --method=SHA-512 ã§ç”Ÿæˆ
        ssh_public_key: "ssh-rsa AAAAB3NzaC1yc2E... user1@company.com"
      - name: user2
        full_name: "Developer User 2"
        uid: 2002
        initial_password_hash: "$6$rounds=4096$salted_hash_here"
        ssh_public_key: "ssh-rsa AAAAB3NzaC1yc2E... user2@company.com"
      - name: user3
        full_name: "Developer User 3"
        uid: 2003
        initial_password_hash: "$6$rounds=4096$salted_hash_here"
        ssh_public_key: "ssh-rsa AAAAB3NzaC1yc2E... user3@company.com"
    
    # Claude Code è¨­å®š
    claude_code_version: "latest"
    node_version: "20"
    shared_api_keys:
      openai: "{{ vault_openai_api_key }}"          # Ansible Vault ã§æš—å·åŒ–
      anthropic: "{{ vault_anthropic_api_key }}"    # Ansible Vault ã§æš—å·åŒ–
      google: "{{ vault_google_api_key }}"          # Ansible Vault ã§æš—å·åŒ–
    
    # ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
    llm_orchestrator_url: "http://localhost:4000"
    base_home_dir: "/home"
    claude_config_template_dir: "/opt/claude-templates"

  tasks:
    # ===== ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ =====
    - name: ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°
      dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      dnf:
        name:
          - git
          - curl
          - wget
          - vim
          - htop
          - tree
          - unzip
          - make
          - gcc-c++
          - openssl-devel
          - python3-pip
          - jq
        state: present

    - name: EPEL ãƒªãƒã‚¸ãƒˆãƒªæœ‰åŠ¹åŒ–
      dnf:
        name: epel-release
        state: present

    - name: Development Tools ã‚°ãƒ«ãƒ¼ãƒ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      dnf:
        name: "@Development Tools"
        state: present

    # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š =====
    - name: firewalld èµ·å‹•ãƒ»æœ‰åŠ¹åŒ–
      systemd:
        name: firewalld
        state: started
        enabled: yes

    - name: SSHè¨­å®šã®å³å¯†åŒ–
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: "^#?PasswordAuthentication", line: "PasswordAuthentication no" }
        - { regexp: "^#?PubkeyAuthentication", line: "PubkeyAuthentication yes" }
        - { regexp: "^#?PermitRootLogin", line: "PermitRootLogin no" }
        - { regexp: "^#?MaxAuthTries", line: "MaxAuthTries 3" }
        - { regexp: "^#?ClientAliveInterval", line: "ClientAliveInterval 300" }
        - { regexp: "^#?ClientAliveCountMax", line: "ClientAliveCountMax 2" }
      notify: restart_sshd

    # ===== Claude Code ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæº–å‚™ =====
    - name: Claude Code è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      file:
        path: "{{ claude_config_template_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Claude Code è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      template:
        src: claude_config_template.json.j2
        dest: "{{ claude_config_template_dir }}/config.json"
        mode: '0644'
        owner: root
        group: root

    - name: ãƒã‚¹ã‚¿ãƒ¼CLAUDE.md ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      template:
        src: claude_md_base.j2
        dest: /opt/claude-templates/CLAUDE_BASE.md
        mode: '0644'
        owner: root
        group: root

    - name: Claude Code åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
      template:
        src: claude_init.sh.j2
        dest: "{{ claude_config_template_dir }}/claude_init.sh"
        mode: '0755'
        owner: root
        group: root

    - name: CLAUDE.mdåŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆé…ç½®
      copy:
        src: claude-md-sync.sh
        dest: /usr/local/bin/claude-md-sync
        mode: '0755'
        owner: root
        group: root

    # ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒæ§‹ç¯‰ =====
    - name: Claude Code ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      user:
        name: "{{ item.name }}"
        uid: "{{ item.uid }}"
        comment: "{{ item.full_name }} - Claude Code User"
        shell: /bin/bash
        home: "{{ base_home_dir }}/{{ item.name }}"
        create_home: yes
        password: "{{ item.initial_password_hash }}"
        groups: wheel
        append: yes
      loop: "{{ claude_users }}"

    - name: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™è¨­å®š
      file:
        path: "{{ base_home_dir }}/{{ item.name }}"
        state: directory
        mode: '0750'  # ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®èª­ã¿å–ã‚Šã‚’åˆ¶é™
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: SSHå…¬é–‹éµè¨­å®š
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.ssh_public_key }}"
        state: present
        manage_dir: yes
      loop: "{{ claude_users }}"

    # ===== NVM + Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨) =====
    - name: NVM ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼)
      shell: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc
        echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc
        echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc
      args:
        creates: "{{ base_home_dir }}/{{ item.name }}/.nvm"
        chdir: "{{ base_home_dir }}/{{ item.name }}"
      become: yes
      become_user: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼)
      shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install {{ node_version }}
        nvm use {{ node_version }}
        nvm alias default {{ node_version }}
      args:
        chdir: "{{ base_home_dir }}/{{ item.name }}"
      become: yes
      become_user: "{{ item.name }}"
      loop: "{{ claude_users }}"

    # ===== Claude Code ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼) =====
    - name: Claude Code CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼)
      shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        npm install -g @anthropic-ai/claude-cli
      args:
        chdir: "{{ base_home_dir }}/{{ item.name }}"
      become: yes
      become_user: "{{ item.name }}"
      loop: "{{ claude_users }}"

    # ===== ~/.claude ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãã®è¨­å®š =====
    - name: .claude ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼)
      file:
        path: "{{ base_home_dir }}/{{ item.name }}/.claude"
        state: directory
        mode: '0700'  # æ‰€æœ‰è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: Claude Code è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é…ç½® (å„ãƒ¦ãƒ¼ã‚¶ãƒ¼)
      template:
        src: user_claude_config.json.j2
        dest: "{{ base_home_dir }}/{{ item.name }}/.claude/config.json"
        mode: '0600'  # æ‰€æœ‰è€…ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: Claude Code CLAUDE.mdï¼ˆé€²åŒ–å‹ï¼‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      template:
        src: claude_md_base.j2
        dest: "{{ base_home_dir }}/{{ item.name }}/.claude/CLAUDE.md"
        mode: '0600'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    # ===== ç’°å¢ƒå¤‰æ•°è¨­å®š =====
    - name: ç’°å¢ƒå¤‰æ•°è¨­å®š (.bashrc)
      blockinfile:
        path: "{{ base_home_dir }}/{{ item.name }}/.bashrc"
        block: |
          # ===== Claude Code & LLM Orchestrator =====
          export CLAUDE_API_KEY="{{ shared_api_keys.anthropic }}"
          export OPENAI_API_KEY="{{ shared_api_keys.openai }}"
          export GOOGLE_API_KEY="{{ shared_api_keys.google }}"
          export LLM_ORCHESTRATOR_URL="{{ llm_orchestrator_url }}"
          export NODE_ENV="production"
          
          # Claude Code ã‚¨ã‚¤ãƒªã‚¢ã‚¹
          alias claude="claude-cli"
          alias llm-status="curl -s {{ llm_orchestrator_url }}/health | jq ."
          alias llm-info="curl -s {{ llm_orchestrator_url }}/info | jq ."
          
          # CLAUDE.md ç®¡ç†ã‚¨ã‚¤ãƒªã‚¢ã‚¹
          alias claude-sync="claude-md-sync sync"
          alias claude-status="claude-md-sync status"
          alias claude-edit="claude-md-sync custom --edit"
          alias claude-backup="claude-md-sync backup"
          
          # ä¾¿åˆ©ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹
          alias ll="ls -alF"
          alias la="ls -A"
          alias l="ls -CF"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Claude Code"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ claude_users }}"

    # ===== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æº–å‚™ =====
    - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      file:
        path: "{{ base_home_dir }}/{{ item.name }}/projects"
        state: directory
        mode: '0755'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: Claude Code ä½¿ç”¨èª¬æ˜æ›¸ä½œæˆ
      template:
        src: claude_usage_guide.md.j2
        dest: "{{ base_home_dir }}/{{ item.name }}/Claude_Code_ä½¿ç”¨èª¬æ˜æ›¸.md"
        mode: '0644'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š (ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥) =====
    - name: ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
      blockinfile:
        path: "{{ base_home_dir }}/{{ item.name }}/.bashrc"
        block: |
          # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š =====
          # å±¥æ­´ã®è¨­å®š
          export HISTSIZE=1000
          export HISTFILESIZE=2000
          export HISTCONTROL=ignoredups:erasedups
          
          # APIã‚­ãƒ¼ä¿è­·ã®æ³¨æ„å–šèµ·
          echo ""
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …:"
          echo "   â€¢ API ã‚­ãƒ¼ã¯ä»–è€…ã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„"
          echo "   â€¢ ~/.claude/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’å¤‰æ›´ã—ãªã„ã§ãã ã•ã„"
          echo "   â€¢ ä¸å¯©ãªæ´»å‹•ã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯ç®¡ç†è€…ã«å ±å‘Šã—ã¦ãã ã•ã„"
          echo ""
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Security"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ claude_users }}"

    # ===== ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š =====
    - name: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ MOTD ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
      template:
        src: user_motd.j2
        dest: "{{ base_home_dir }}/{{ item.name }}/.hushlogin"
        mode: '0644'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã® Claude Code å‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ
      template:
        src: login_check.sh.j2
        dest: "{{ base_home_dir }}/{{ item.name }}/.claude_login_check.sh"
        mode: '0750'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ claude_users }}"

    - name: ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ .profile ã«è¿½åŠ 
      lineinfile:
        path: "{{ base_home_dir }}/{{ item.name }}/.profile"
        line: "[ -x ~/.claude_login_check.sh ] && ~/.claude_login_check.sh"
        create: yes
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ claude_users }}"

  # ===== ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
  handlers:
    - name: restart_sshd
      systemd:
        name: sshd
        state: restarted

    - name: reload_firewalld
      systemd:
        name: firewalld
        state: reloaded

# ===== å®Ÿè¡Œå¾Œã®ç¢ºèªã‚¿ã‚¹ã‚¯ =====
- name: ç’°å¢ƒæ§‹ç¯‰ç¢ºèª
  hosts: rocky_llm_vms
  become: no
  gather_facts: no
  tasks:
    - name: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç¢ºèª
      command: "getent passwd"
      register: user_list
      
    - name: æ§‹ç¯‰ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º
      debug:
        msg: "æ§‹ç¯‰æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ claude_users | map(attribute='name') | join(', ') }}"

    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      debug:
        msg: |
          ğŸ‰ ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒæ§‹ç¯‰å®Œäº†ï¼
          
          âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
          1. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«SSHæ¥ç¶šæƒ…å ±ã‚’é€šçŸ¥
          2. åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚’æ¨å¥¨
          3. Claude Codeå‹•ä½œç¢ºèªå®Ÿè¡Œ
          4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œ
          
          ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª:
          â€¢ SSHå…¬é–‹éµèªè¨¼ã®ã¿æœ‰åŠ¹
          â€¢ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç„¡åŠ¹åŒ–
          â€¢ å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® ~/.claude ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ 0700 æ¨©é™
          â€¢ API ã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
          â€¢ ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º