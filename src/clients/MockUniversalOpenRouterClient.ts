import { 
  BaseLLMClient, 
  LLMResponse, 
  GenerationOptions, 
  UsageStats,
  ModelConfig
} from '../types';
import { OpenRouterModelInfo } from './UniversalOpenRouterClient';

/**
 * MockUniversalOpenRouterClient - OpenRouter APIã‚­ãƒ¼ãªã—ã§ã®ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
 * å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ãªã—ã§ã€OpenRouterãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
 */
export class MockUniversalOpenRouterClient implements BaseLLMClient {
  private modelConfig: ModelConfig;
  private stats: UsageStats;
  private openRouterModelInfo?: OpenRouterModelInfo;
  private requestCount: number = 0;

  constructor(modelConfig: ModelConfig, openRouterModelInfo?: OpenRouterModelInfo) {
    this.modelConfig = modelConfig;
    this.openRouterModelInfo = openRouterModelInfo;
    this.stats = {
      total_requests: 0,
      successful_requests: 0,
      failed_requests: 0,
      average_latency_ms: 0,
      total_tokens_used: 0,
      total_cost_usd: 0
    };

    console.log(`[MockOpenRouter] ğŸ”„ Mock ${modelConfig.name} client initialized (testing mode)`);
  }

  async generate(prompt: string, options?: GenerationOptions): Promise<LLMResponse> {
    const startTime = Date.now();
    this.requestCount++;
    
    // ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ
    const mockResponse = this.generateMockResponse(prompt, options);
    
    // çµ±è¨ˆæ›´æ–°
    const processingTime = Date.now() - startTime;
    this.stats.total_requests++;
    this.stats.successful_requests++;
    this.stats.average_latency_ms = (this.stats.average_latency_ms + processingTime) / 2;
    this.stats.total_tokens_used += mockResponse.metadata.tokens_used.total;
    this.stats.total_cost_usd += mockResponse.cost_info.total_cost_usd;

    console.log(`[MockOpenRouter] ğŸ“¤ Mock response generated for ${this.modelConfig.name} (${processingTime}ms)`);
    
    return mockResponse;
  }

  private generateMockResponse(prompt: string, options?: GenerationOptions): LLMResponse {
    const inputTokens = Math.ceil(prompt.length / 4);
    let outputTokens: number;
    let responseText: string;

    // ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
    if (this.modelConfig.capabilities.includes('coding')) {
      outputTokens = Math.min(inputTokens * 2, 400);
      responseText = this.generateMockCodeResponse(prompt);
    } else if (this.modelConfig.capabilities.includes('creative_writing')) {
      outputTokens = Math.min(inputTokens * 1.5, 300);
      responseText = this.generateMockCreativeResponse(prompt);
    } else if (this.modelConfig.capabilities.includes('mathematics')) {
      outputTokens = Math.min(inputTokens * 1.2, 200);
      responseText = this.generateMockMathResponse(prompt);
    } else {
      outputTokens = Math.min(inputTokens * 1.3, 250);
      responseText = this.generateMockGeneralResponse(prompt);
    }

    const totalTokens = inputTokens + outputTokens;
    const inputCost = (inputTokens / 1000) * (this.openRouterModelInfo?.pricing.prompt || this.modelConfig.cost_per_1k_tokens.input);
    const outputCost = (outputTokens / 1000) * (this.openRouterModelInfo?.pricing.completion || this.modelConfig.cost_per_1k_tokens.output);

    return {
      success: true,
      model_used: this.modelConfig.name,
      tier_used: this.modelConfig.tier,
      response_text: responseText,
      metadata: {
        model_id: this.modelConfig.id,
        provider: 'openrouter_mock',
        tokens_used: {
          input: inputTokens,
          output: outputTokens,
          total: totalTokens
        },
        generated_at: new Date().toISOString(),
        session_id: `mock_session_${this.requestCount}`,
        tier_used: this.modelConfig.tier,
        processing_time_ms: 200 + Math.random() * 800, // 200-1000ms simulation
        estimated_complexity: Math.floor(Math.random() * 5) + 1,
        openrouter_model: this.openRouterModelInfo?.id,
        finish_reason: 'stop'
      },
      cost_info: {
        total_cost_usd: inputCost + outputCost,
        input_cost_usd: inputCost,
        output_cost_usd: outputCost
      },
      performance_info: {
        latency_ms: 200 + Math.random() * 800,
        processing_time_ms: 150 + Math.random() * 600,
        queue_time_ms: Math.random() * 50,
        fallback_used: false,
        tier_escalation: false
      }
    };
  }

  private generateMockCodeResponse(prompt: string): string {
    const codeSnippets = [
      `# ${this.modelConfig.name}ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¾‹\ndef example_function(param):\n    \"\"\"Generated by ${this.modelConfig.name}\"\"\"\n    result = param * 2 + 1\n    return result\n\n# ãƒ†ã‚¹ãƒˆä¾‹\nif __name__ == "__main__":\n    print(example_function(5))`,
      
      `// ${this.modelConfig.name} JavaScript Example\nfunction processData(input) {\n  // Mock implementation generated by ${this.modelConfig.name}\n  return input.map(item => ({\n    ...item,\n    processed: true,\n    timestamp: new Date().toISOString()\n  }));\n}\n\nmodule.exports = { processData };`,
      
      `/* ${this.modelConfig.name} - TypeScript Interface */\ninterface MockResponse {\n  id: string;\n  data: any[];\n  generated_by: '${this.modelConfig.name}';\n  created_at: string;\n}\n\nclass MockService {\n  async process(): Promise<MockResponse> {\n    return {\n      id: 'mock_' + Date.now(),\n      data: [],\n      generated_by: '${this.modelConfig.name}',\n      created_at: new Date().toISOString()\n    };\n  }\n}`
    ];
    
    return codeSnippets[Math.floor(Math.random() * codeSnippets.length)];
  }

  private generateMockGeneralResponse(prompt: string): string {
    const responses = [
      `${this.modelConfig.name}ã«ã‚ˆã‚‹å›ç­”:\n\nã”è³ªå•ã€Œ${prompt.substring(0, 50)}...ã€ã«ã¤ã„ã¦èª¬æ˜ã„ãŸã—ã¾ã™ã€‚\n\nã“ã‚Œã¯${this.modelConfig.name}ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ãƒ¢ãƒƒã‚¯å¿œç­”ã§ã™ã€‚å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã¯è¡Œã‚ã‚Œã¦ãŠã‚‰ãšã€ãƒ†ã‚¹ãƒˆç›®çš„ã§ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿œç­”ã¨ãªã‚Šã¾ã™ã€‚\n\nä¸»ãªãƒã‚¤ãƒ³ãƒˆ:\n- ãƒ¢ãƒ‡ãƒ«: ${this.modelConfig.name}\n- Tier: ${this.modelConfig.tier}\n- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: OpenRouter (Mock)\n- å¿œç­”æ™‚é–“: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`,
      
      `ã€${this.modelConfig.name}ã‹ã‚‰ã®å¿œç­”ã€‘\n\nãŠå•ã„åˆã‚ã›å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚\n\n${this.modelConfig.name}ã¯${this.modelConfig.tier === 0 ? 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç‰¹åŒ–' : this.modelConfig.tier === 1 ? 'é«˜é€Ÿæ±ç”¨' : this.modelConfig.tier === 2 ? 'é«˜å“è³ªæ¨è«–' : 'æœ€é«˜å“è³ª'}ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™:\n\n${this.modelConfig.capabilities.map(cap => `â€¢ ${cap}`).join('\n')}\n\næ³¨æ„: ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯å¿œç­”ã§ã™ã€‚`,
      
      `${this.modelConfig.name}ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¿œç­”\n\nãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æçµæœ:\n- å…¥åŠ›é•·: ${prompt.length}æ–‡å­—\n- æ¨å®šè¤‡é›‘åº¦: ${Math.floor(Math.random() * 5) + 1}/5\n- æ¨å¥¨Tier: ${this.modelConfig.tier}\n\nã“ã®å¿œç­”ã¯${this.modelConfig.name}ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸã‚‚ã®ã§ã™ã€‚å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã¯ã€OpenRouterçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ç”Ÿæˆã•ã‚Œã‚‹é«˜å“è³ªãªå¿œç­”ãŒæä¾›ã•ã‚Œã¾ã™ã€‚`
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
  }

  private generateMockCreativeResponse(prompt: string): string {
    return `âœ¨ ${this.modelConfig.name} - å‰µä½œãƒ¢ãƒ¼ãƒ‰ âœ¨\n\nã€Œ${prompt.substring(0, 30)}...ã€ã‚’ãƒ†ãƒ¼ãƒã¨ã—ãŸå‰µä½œä¾‹:\n\næ˜”ã€…ã€ã¨ã‚ã‚‹é–‹ç™ºè€…ãŒAIã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã—ãŸã€‚ãã®åã‚‚ã€Œ5å±¤ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰LLMã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã€ã€‚\n\nã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯${this.modelConfig.name}ã‚’å«ã‚€13ç¨®é¡ä»¥ä¸Šã®AIãƒ¢ãƒ‡ãƒ«ã‚’çµ±åˆã—ã€ã‚¿ã‚¹ã‚¯ã«å¿œã˜ã¦æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•é¸æŠã™ã‚‹é©æ–°çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã—ãŸ...\n\nï¼ˆâ€»ã“ã‚Œã¯${this.modelConfig.name}ã«ã‚ˆã‚‹ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªãƒ¢ãƒƒã‚¯å¿œç­”ã§ã™ï¼‰`;
  }

  private generateMockMathResponse(prompt: string): string {
    return `ğŸ”¢ ${this.modelConfig.name} - æ•°å­¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰\n\nå•é¡Œåˆ†æ: ${prompt.substring(0, 50)}...\n\nè§£æ³•ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:\n1. å•é¡Œã®å®šå¼åŒ–\n2. é©åˆ‡ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é¸æŠ\n3. æ®µéšçš„è§£æ³•ã®å®Ÿè¡Œ\n\nä¾‹: 2Â² + 3Â² = 4 + 9 = 13\n\nâ€» å®Ÿéš›ã®è¨ˆç®—ã¯OpenRouterçµŒç”±ã§${this.modelConfig.name}ãŒå®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ¢ãƒƒã‚¯ä¾‹ã§ã™ã€‚`;
  }

  async isHealthy(): Promise<boolean> {
    console.log(`[MockOpenRouter] âœ… ${this.modelConfig.name} health check - OK (mock)`);
    return true;
  }

  async getUsageStats(): Promise<UsageStats> {
    return { ...this.stats };
  }

  /**
   * å®Ÿéš›ã®OpenRouterã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®åˆ‡ã‚Šæ›¿ãˆãƒ¡ã‚½ãƒƒãƒ‰
   * APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚ŒãŸã¨ãã«å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
   */
  canUpgradeToReal(): boolean {
    return !!process.env.OPENROUTER_API_KEY && 
           !process.env.OPENROUTER_API_KEY.includes('test') &&
           !process.env.OPENROUTER_API_KEY.includes('development');
  }

  getModelInfo(): { config: ModelConfig; openRouterInfo?: OpenRouterModelInfo } {
    return {
      config: this.modelConfig,
      openRouterInfo: this.openRouterModelInfo
    };
  }
}